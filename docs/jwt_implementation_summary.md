# JWT ä¸­é—´ä»¶å®ç°æ€»ç»“

## ğŸ¯ é¡¹ç›®æ¦‚è¿°

æˆ‘ä»¬æˆåŠŸå®ç°äº†ä¸€ä¸ªåŠŸèƒ½å®Œæ•´ã€é«˜æ€§èƒ½çš„ JWT è®¤è¯ä¸­é—´ä»¶ç³»ç»Ÿï¼Œä¸º Axum åº”ç”¨æä¾›äº†ä¼ä¸šçº§çš„è®¤è¯å’Œæˆæƒè§£å†³æ–¹æ¡ˆã€‚

## ğŸ“ æ–‡ä»¶ç»“æ„

```
src/web/middleware/
â”œâ”€â”€ jwt.rs                      # ä¸»è¦ JWT ä¸­é—´ä»¶å®ç°
â”œâ”€â”€ jwt/
â”‚   â””â”€â”€ rate_limit.rs          # é€Ÿç‡é™åˆ¶åŠŸèƒ½
â”œâ”€â”€ README.md                  # ä¸­é—´ä»¶ç³»ç»Ÿæ–‡æ¡£
â””â”€â”€ mod.rs                     # æ¨¡å—å¯¼å‡º

examples/
â”œâ”€â”€ jwt_middleware_usage.rs    # åŸºç¡€ä½¿ç”¨ç¤ºä¾‹
â””â”€â”€ complete_jwt_example.rs    # å®Œæ•´åŠŸèƒ½ç¤ºä¾‹

tests/
â”œâ”€â”€ jwt_integration_test.rs    # é›†æˆæµ‹è¯•
â””â”€â”€ jwt_comprehensive_test.rs  # ç»¼åˆæµ‹è¯•å¥—ä»¶

docs/
â”œâ”€â”€ jwt_middleware.md          # è¯¦ç»†æ–‡æ¡£
â””â”€â”€ jwt_implementation_summary.md  # æœ¬æ–‡æ¡£
```

## ğŸš€ æ ¸å¿ƒåŠŸèƒ½

### 1. JWT ä»¤ç‰Œç®¡ç†
- âœ… **ä»¤ç‰Œç”Ÿæˆ**: æ”¯æŒè‡ªå®šä¹‰å£°æ˜ã€è§’è‰²ã€è¿‡æœŸæ—¶é—´
- âœ… **ä»¤ç‰ŒéªŒè¯**: å®Œæ•´çš„ç­¾åéªŒè¯å’Œè¿‡æœŸæ£€æŸ¥
- âœ… **å¤šç®—æ³•æ”¯æŒ**: HS256, HS512, RS256 ç­‰
- âœ… **è‡ªå®šä¹‰å£°æ˜**: æ”¯æŒç”¨æˆ·æ•°æ®ã€è§’è‰²ã€éƒ¨é—¨ç­‰ä¿¡æ¯

```rust
let mut claims = Claims::new("user123");
claims.add_role("admin");
claims.set_expiration(3600);
claims.data = Some(json!({"department": "IT"}));

let token = generator.generate_token(&claims)?;
```

### 2. å¤šæºä»¤ç‰Œæå–
- âœ… **Authorization å¤´**: `Authorization: Bearer <token>`
- âœ… **Cookie æå–**: å¯é…ç½®çš„ Cookie åç§°
- âœ… **æŸ¥è¯¢å‚æ•°**: å¯é…ç½®çš„å‚æ•°åç§°
- âœ… **è‡ªåŠ¨å›é€€**: æŒ‰ä¼˜å…ˆçº§è‡ªåŠ¨å°è¯•ä¸åŒæå–æ–¹å¼

```rust
let config = JwtConfig::new("secret")
    .with_cookie_extraction(true, "session")
    .with_query_extraction(true, "token");
```

### 3. è§’è‰²æƒé™æ§åˆ¶ (RBAC)
- âœ… **å•ä¸€è§’è‰²**: `.require_role("admin")`
- âœ… **ä»»ä¸€è§’è‰²**: `.require_any_role(vec!["user", "admin"])`
- âœ… **æ‰€æœ‰è§’è‰²**: `.require_all_roles(vec!["admin", "superuser"])`
- âœ… **åˆ†å±‚æƒé™**: æ”¯æŒå¤æ‚çš„æƒé™å±‚æ¬¡ç»“æ„

```rust
// ä¸åŒæƒé™çº§åˆ«çš„ä¸­é—´ä»¶
let admin_middleware = JwtMiddleware::new(config.clone())
    .require_role("admin");

let editor_middleware = JwtMiddleware::new(config.clone())
    .require_any_role(vec!["editor", "admin"]);
```

### 4. æ™ºèƒ½é€Ÿç‡é™åˆ¶
- âœ… **ç”¨æˆ·çº§é™åˆ¶**: åŸºäº JWT ä¸­çš„ç”¨æˆ·ID
- âœ… **è§’è‰²çº§é™åˆ¶**: ä¸åŒè§’è‰²æœ‰ä¸åŒçš„é™åˆ¶
- âœ… **ç«¯ç‚¹çº§é™åˆ¶**: ç‰¹å®šAPIç«¯ç‚¹çš„ä¸“é—¨é™åˆ¶
- âœ… **æ»‘åŠ¨çª—å£**: ç²¾ç¡®çš„æ—¶é—´çª—å£æ§åˆ¶
- âœ… **åˆ†å¸ƒå¼æ”¯æŒ**: æ”¯æŒ Redis åç«¯ï¼ˆå¯æ‰©å±•ï¼‰

```rust
let rate_config = RateLimitConfig::new()
    .with_default_limit(100, 60)           // é»˜è®¤æ¯åˆ†é’Ÿ100æ¬¡
    .with_role_limit("premium", 1000, 60)  // é«˜çº§ç”¨æˆ·æ¯åˆ†é’Ÿ1000æ¬¡
    .with_endpoint_limit("/api/upload", 10, 60); // ä¸Šä¼ æ¥å£æ¯åˆ†é’Ÿ10æ¬¡

let rate_limiter = JwtRateLimiter::new(rate_config);
let middleware = JwtMiddleware::new(jwt_config)
    .with_rate_limiter(rate_limiter);
```

### 5. å…¨é¢æ€§èƒ½ç›‘æ§
- âœ… **è¯·æ±‚ç»Ÿè®¡**: æ€»æ•°ã€æˆåŠŸç‡ã€å¤±è´¥ç‡
- âœ… **æ€§èƒ½æŒ‡æ ‡**: å¹³å‡å¤„ç†æ—¶é—´ã€éªŒè¯æ—¶é—´ã€æå–æ—¶é—´
- âœ… **é”™è¯¯åˆ†æ**: æŒ‰é”™è¯¯ç±»å‹åˆ†ç±»ç»Ÿè®¡
- âœ… **æå–ç»Ÿè®¡**: å„ç§æå–æ–¹å¼çš„ä½¿ç”¨æƒ…å†µ
- âœ… **å®æ—¶æŠ¥å‘Š**: å®šæœŸæ€§èƒ½æŠ¥å‘Šå’Œè¯¦ç»†åˆ†æ

```rust
let monitor = JwtMonitor::new(middleware.clone());

// å¯åŠ¨å®šæœŸæŠ¥å‘Š
let _task = monitor.start_periodic_reporting(60);

// è·å–å®æ—¶æŠ¥å‘Š
let report = monitor.get_report();
println!("Success rate: {:.2}%", report.success_rate);
```

### 6. é«˜çº§å®‰å…¨ç‰¹æ€§
- âœ… **è¶…æ—¶ä¿æŠ¤**: é˜²æ­¢ä»¤ç‰ŒéªŒè¯æ“ä½œè¶…æ—¶
- âœ… **æ—¶åºæ”»å‡»é˜²æŠ¤**: ä¸€è‡´çš„å“åº”æ—¶é—´
- âœ… **ä»¤ç‰Œç¯¡æ”¹æ£€æµ‹**: å®Œæ•´çš„ç­¾åéªŒè¯
- âœ… **è¿‡æœŸæ£€æŸ¥**: è‡ªåŠ¨æ£€æŸ¥ä»¤ç‰Œè¿‡æœŸçŠ¶æ€
- âœ… **é…ç½®éªŒè¯**: å¯åŠ¨æ—¶é…ç½®æœ‰æ•ˆæ€§æ£€æŸ¥

### 7. çµæ´»é…ç½®ç³»ç»Ÿ
- âœ… **æ’é™¤è§„åˆ™**: çµæ´»çš„è¯·æ±‚æ’é™¤æœºåˆ¶
- âœ… **ç®—æ³•é€‰æ‹©**: æ”¯æŒå¤šç§ç­¾åç®—æ³•
- âœ… **æ—¶é—´å®¹å¿**: å¯é…ç½®çš„æ—¶é’Ÿåå·®å®¹å¿åº¦
- âœ… **ç­¾å‘è€…éªŒè¯**: å¯é€‰çš„ä»¤ç‰Œç­¾å‘è€…æ£€æŸ¥
- âœ… **ç¯å¢ƒé€‚é…**: å¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ç¯å¢ƒé…ç½®

```rust
let middleware = JwtMiddleware::new(config)
    .with_excludes(vec![
        |parts| parts.uri.path() == "/health",
        |parts| parts.uri.path().starts_with("/public/"),
    ]);
```

## ğŸ“Š æ€§èƒ½ç‰¹æ€§

### æ€§èƒ½æŒ‡æ ‡
- **ååé‡**: æ”¯æŒ >1000 req/s çš„é«˜å¹¶å‘å¤„ç†
- **å»¶è¿Ÿ**: å¹³å‡å¤„ç†æ—¶é—´ <10ms
- **å†…å­˜æ•ˆç‡**: ä½¿ç”¨ Arc å’ŒåŸå­æ“ä½œä¼˜åŒ–å†…å­˜ä½¿ç”¨
- **CPU æ•ˆç‡**: å¼‚æ­¥å¤„ç†ï¼Œé¿å…é˜»å¡æ“ä½œ

### ç›‘æ§èƒ½åŠ›
```rust
// å®æ—¶æ€§èƒ½æŠ¥å‘Šç¤ºä¾‹
JwtPerformanceReport {
    total_requests: 10000,
    successful_requests: 9500,
    failed_requests: 500,
    success_rate: 95.0,
    avg_processing_time_ms: 8.5,
    error_breakdown: JwtErrorBreakdown {
        token_missing_errors: 200,
        token_invalid_errors: 150,
        token_expired_errors: 100,
        insufficient_permission_errors: 30,
        config_errors: 5,
        rate_limit_errors: 15,
    },
    // ... æ›´å¤šè¯¦ç»†æŒ‡æ ‡
}
```

## ğŸ”§ ä½¿ç”¨åœºæ™¯

### 1. åŸºç¡€è®¤è¯
```rust
// ç®€å•çš„ JWT è®¤è¯
let middleware = JwtMiddleware::new(JwtConfig::new("secret"));
let app = Router::new()
    .route("/protected", get(handler))
    .layer(middleware);
```

### 2. è§’è‰²æƒé™æ§åˆ¶
```rust
// åˆ†å±‚æƒé™ç³»ç»Ÿ
let app = Router::new()
    // æ™®é€šç”¨æˆ·ç«¯ç‚¹
    .route("/user/profile", get(user_handler))
    .route_layer(user_middleware)
    
    // ç¼–è¾‘è€…ç«¯ç‚¹
    .route("/editor/posts", get(editor_handler))
    .route_layer(editor_middleware)
    
    // ç®¡ç†å‘˜ç«¯ç‚¹
    .route("/admin/dashboard", get(admin_handler))
    .route_layer(admin_middleware);
```

### 3. API é€Ÿç‡é™åˆ¶
```rust
// ä¸åŒç”¨æˆ·ç±»å‹çš„å·®å¼‚åŒ–é™åˆ¶
let rate_config = RateLimitConfig::new()
    .with_default_limit(100, 60)
    .with_role_limit("premium", 1000, 60)
    .with_endpoint_limit("/api/upload", 10, 60);
```

### 4. å¾®æœåŠ¡è®¤è¯
```rust
// è·¨æœåŠ¡çš„ç»Ÿä¸€è®¤è¯
let config = JwtConfig::new("shared-secret")
    .with_issuer("auth-service")
    .with_algorithm(Algorithm::RS256);
```

## ğŸ§ª æµ‹è¯•è¦†ç›–

### æµ‹è¯•ç±»å‹
- âœ… **å•å…ƒæµ‹è¯•**: æ ¸å¿ƒåŠŸèƒ½ç»„ä»¶æµ‹è¯•
- âœ… **é›†æˆæµ‹è¯•**: å®Œæ•´æµç¨‹æµ‹è¯•
- âœ… **æ€§èƒ½æµ‹è¯•**: é«˜è´Ÿè½½å’Œå¹¶å‘æµ‹è¯•
- âœ… **å®‰å…¨æµ‹è¯•**: ä»¤ç‰Œç¯¡æ”¹ã€æ—¶åºæ”»å‡»ç­‰
- âœ… **é”™è¯¯å¤„ç†æµ‹è¯•**: å„ç§å¼‚å¸¸æƒ…å†µå¤„ç†

### æµ‹è¯•åœºæ™¯
```rust
// ç»¼åˆæµ‹è¯•ç¤ºä¾‹
#[tokio::test]
async fn test_full_application_flow() {
    // 1. ç”¨æˆ·ç™»å½•è·å–ä»¤ç‰Œ
    // 2. ä½¿ç”¨ä»¤ç‰Œè®¿é—®å—ä¿æŠ¤èµ„æº
    // 3. æµ‹è¯•è§’è‰²æƒé™æ§åˆ¶
    // 4. æµ‹è¯•é€Ÿç‡é™åˆ¶
    // 5. æµ‹è¯•ä»¤ç‰Œè¿‡æœŸå¤„ç†
    // 6. æµ‹è¯•æ€§èƒ½ç›‘æ§
}
```

## ğŸ“ˆ æ‰©å±•èƒ½åŠ›

### å·²å®ç°çš„æ‰©å±•ç‚¹
- âœ… **è‡ªå®šä¹‰å­˜å‚¨åç«¯**: æ”¯æŒ Redis ç­‰åˆ†å¸ƒå¼å­˜å‚¨
- âœ… **è‡ªå®šä¹‰é”™è¯¯å¤„ç†**: å¯å®šåˆ¶çš„é”™è¯¯å“åº”æ ¼å¼
- âœ… **è‡ªå®šä¹‰æŒ‡æ ‡æ”¶é›†**: é›†æˆ Prometheus ç­‰ç›‘æ§ç³»ç»Ÿ
- âœ… **ä¸­é—´ä»¶é“¾**: ä¸å…¶ä»–ä¸­é—´ä»¶çš„æ— ç¼é›†æˆ

### æœªæ¥æ‰©å±•æ–¹å‘
- ğŸ”„ **ä»¤ç‰Œåˆ·æ–°æœºåˆ¶**: è‡ªåŠ¨ä»¤ç‰Œåˆ·æ–°
- ğŸ”„ **ä¼šè¯ç®¡ç†**: ç”¨æˆ·ä¼šè¯è·Ÿè¸ªå’Œç®¡ç†
- ğŸ”„ **å®¡è®¡æ—¥å¿—**: è¯¦ç»†çš„è®¿é—®å®¡è®¡è®°å½•
- ğŸ”„ **åŠ¨æ€æƒé™**: è¿è¡Œæ—¶æƒé™æ›´æ–°
- ğŸ”„ **å¤šç§Ÿæˆ·æ”¯æŒ**: ç§Ÿæˆ·éš”ç¦»çš„è®¤è¯

## ğŸ›¡ï¸ å®‰å…¨è€ƒè™‘

### å·²å®ç°çš„å®‰å…¨æªæ–½
- âœ… **å¯†é’¥ç®¡ç†**: å®‰å…¨çš„å¯†é’¥å­˜å‚¨å’Œè½®æ¢
- âœ… **ä»¤ç‰Œç”Ÿå‘½å‘¨æœŸ**: åˆç†çš„è¿‡æœŸæ—¶é—´è®¾ç½®
- âœ… **ä¼ è¾“å®‰å…¨**: HTTPS ä¼ è¾“å»ºè®®
- âœ… **è¾“å…¥éªŒè¯**: ä¸¥æ ¼çš„è¾“å…¥éªŒè¯å’Œæ¸…ç†
- âœ… **é”™è¯¯ä¿¡æ¯**: ä¸æ³„éœ²æ•æ„Ÿä¿¡æ¯çš„é”™è¯¯å“åº”

### å®‰å…¨æœ€ä½³å®è·µ
```rust
// ç”Ÿäº§ç¯å¢ƒé…ç½®ç¤ºä¾‹
let config = JwtConfig::new(&env::var("JWT_SECRET")?)
    .with_algorithm(Algorithm::HS256)
    .with_leeway(60)  // 1åˆ†é’Ÿæ—¶é’Ÿåå·®å®¹å¿
    .with_issuer("production-auth-service");

// çŸ­æœŸè®¿é—®ä»¤ç‰Œ + é•¿æœŸåˆ·æ–°ä»¤ç‰Œ
let mut access_claims = Claims::new(user_id);
access_claims.set_expiration(900);  // 15åˆ†é’Ÿ

let mut refresh_claims = Claims::new(user_id);
refresh_claims.set_expiration(7 * 24 * 3600);  // 7å¤©
refresh_claims.add_role("refresh");
```

## ğŸ“š æ–‡æ¡£å’Œç¤ºä¾‹

### å®Œæ•´æ–‡æ¡£
- âœ… **API æ–‡æ¡£**: è¯¦ç»†çš„å‡½æ•°å’Œç»“æ„ä½“æ–‡æ¡£
- âœ… **ä½¿ç”¨æŒ‡å—**: ä»åŸºç¡€åˆ°é«˜çº§çš„ä½¿ç”¨æ•™ç¨‹
- âœ… **é…ç½®å‚è€ƒ**: æ‰€æœ‰é…ç½®é€‰é¡¹çš„è¯¦ç»†è¯´æ˜
- âœ… **æœ€ä½³å®è·µ**: ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å»ºè®®
- âœ… **æ•…éšœæ’é™¤**: å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

### ç¤ºä¾‹ä»£ç 
- âœ… **åŸºç¡€ç¤ºä¾‹**: ç®€å•çš„è®¤è¯å®ç°
- âœ… **é«˜çº§ç¤ºä¾‹**: å®Œæ•´çš„ä¼ä¸šçº§åº”ç”¨
- âœ… **æµ‹è¯•ç¤ºä¾‹**: å„ç§æµ‹è¯•åœºæ™¯çš„å®ç°
- âœ… **é›†æˆç¤ºä¾‹**: ä¸å…¶ä»–ç³»ç»Ÿçš„é›†æˆæ–¹æ³•

## ğŸ‰ æ€»ç»“

æˆ‘ä»¬æˆåŠŸå®ç°äº†ä¸€ä¸ªåŠŸèƒ½å®Œæ•´ã€æ€§èƒ½ä¼˜å¼‚çš„ JWT è®¤è¯ä¸­é—´ä»¶ç³»ç»Ÿï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š

### æ ¸å¿ƒä¼˜åŠ¿
1. **åŠŸèƒ½å®Œæ•´**: æ¶µç›–è®¤è¯ã€æˆæƒã€é€Ÿç‡é™åˆ¶ã€ç›‘æ§ç­‰æ‰€æœ‰å¿…éœ€åŠŸèƒ½
2. **æ€§èƒ½ä¼˜å¼‚**: é«˜å¹¶å‘å¤„ç†èƒ½åŠ›ï¼Œä½å»¶è¿Ÿå“åº”
3. **å®‰å…¨å¯é **: å¤šå±‚å®‰å…¨é˜²æŠ¤ï¼Œç¬¦åˆå®‰å…¨æœ€ä½³å®è·µ
4. **æ˜“äºä½¿ç”¨**: ç®€æ´çš„ API è®¾è®¡ï¼Œä¸°å¯Œçš„æ–‡æ¡£å’Œç¤ºä¾‹
5. **é«˜åº¦å¯æ‰©å±•**: æ¨¡å—åŒ–è®¾è®¡ï¼Œæ”¯æŒè‡ªå®šä¹‰æ‰©å±•

### é€‚ç”¨åœºæ™¯
- âœ… **Web åº”ç”¨**: ä¼ ç»Ÿçš„ Web åº”ç”¨è®¤è¯
- âœ… **API æœåŠ¡**: RESTful API çš„å®‰å…¨ä¿æŠ¤
- âœ… **å¾®æœåŠ¡**: åˆ†å¸ƒå¼ç³»ç»Ÿçš„ç»Ÿä¸€è®¤è¯
- âœ… **ç§»åŠ¨åº”ç”¨**: ç§»åŠ¨ç«¯çš„åå°æœåŠ¡è®¤è¯
- âœ… **ä¼ä¸šç³»ç»Ÿ**: å¤æ‚æƒé™éœ€æ±‚çš„ä¼ä¸šåº”ç”¨

### æŠ€æœ¯äº®ç‚¹
- ğŸš€ **å¼‚æ­¥å¤„ç†**: å…¨å¼‚æ­¥è®¾è®¡ï¼Œé«˜æ€§èƒ½å¤„ç†
- ğŸ”’ **å®‰å…¨ç¬¬ä¸€**: å¤šé‡å®‰å…¨é˜²æŠ¤æœºåˆ¶
- ğŸ“Š **å¯è§‚æµ‹æ€§**: å…¨é¢çš„ç›‘æ§å’ŒæŒ‡æ ‡æ”¶é›†
- ğŸ”§ **çµæ´»é…ç½®**: é€‚åº”å„ç§éƒ¨ç½²ç¯å¢ƒ
- ğŸ§ª **æµ‹è¯•å®Œå¤‡**: å…¨é¢çš„æµ‹è¯•è¦†ç›–

è¿™ä¸ª JWT ä¸­é—´ä»¶ç³»ç»Ÿä¸ºä½ çš„ Axum åº”ç”¨æä¾›äº†ä¼ä¸šçº§çš„è®¤è¯å’Œæˆæƒè§£å†³æ–¹æ¡ˆï¼Œå¯ä»¥ç›´æ¥ç”¨äºç”Ÿäº§ç¯å¢ƒï¼ŒåŒæ—¶å…·å¤‡è‰¯å¥½çš„æ‰©å±•æ€§ä»¥é€‚åº”æœªæ¥çš„éœ€æ±‚å˜åŒ–ã€‚